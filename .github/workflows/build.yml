name: Build Windows and macOS App

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build with PyInstaller
      shell: cmd
      run: |
        pyinstaller --noconfirm --onedir --windowed --name "MaterialReview" ^
        --add-data "config.yaml;." ^
        --add-data "main.py;." ^
        --add-data "src;src" ^
        --collect-all "cv2" ^
        --collect-all "numpy" ^
        --hidden-import "PIL" ^
        --hidden-import "PIL._tkinter_finder" ^
        --hidden-import "yaml" ^
        --hidden-import "click" ^
        --hidden-import "rich" ^
        --hidden-import "jinja2" ^
        --hidden-import "zhipuai" ^
        --hidden-import "openai" ^
        --hidden-import "cv2" ^
        --hidden-import "numpy" ^
        --hidden-import "imaplib" ^
        --hidden-import "email" ^
        --hidden-import "ssl" ^
        --runtime-hook "pyi_rth_cv2fix.py" ^
        gui.py
        
    - name: Compress Artifact
      shell: pwsh
      run: |
        Compress-Archive -Path "dist\MaterialReview" -DestinationPath "dist\MaterialReview_Windows.zip" -Force
        
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MaterialReview_Windows
        path: dist/MaterialReview_Windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies and build DMG
      shell: bash
      run: |
        set -e
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        export MACOSX_DEPLOYMENT_TARGET=11.0
        pyinstaller --name="MaterialReview" \
          --windowed \
          --onedir \
          --add-data="config.yaml:." \
          --add-data="main.py:." \
          --add-data="src:src" \
          --hidden-import=PIL \
          --hidden-import=PIL._tkinter_finder \
          --hidden-import=yaml \
          --hidden-import=click \
          --hidden-import=rich \
          --hidden-import=jinja2 \
          --hidden-import=zhipuai \
          --hidden-import=openai \
          --hidden-import=cv2 \
          --hidden-import=numpy \
          --hidden-import=imaplib \
          --hidden-import=email \
          --hidden-import=ssl \
          --runtime-hook=pyi_rth_cv2fix.py \
          --noconfirm \
          gui.py
        hdiutil create -volname "MaterialReview" -srcfolder "dist/MaterialReview.app" -ov -format UDZO "dist/MaterialReview.dmg"

    - name: Upload DMG Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MaterialReview_macOS
        path: dist/MaterialReview.dmg
